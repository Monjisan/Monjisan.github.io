<!DOCTYPE>
<html>
<head>
<title>GPS and MAPapis test</title>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyBDj8H5CMzqonMcl8Qfrl_AzXo0SEDmtDU&sensor=false"></script>
<script type="text/javascript" src="../js/jquery-1.11.0.min.js"></script>
<script type="text/javascript">
var map,pos=[0,0],getpos=[0,0];
var circle, defPos = new google.maps.LatLng(-34.397, 150.644);
function initialize(){

  // get GPS sector
  var cb=function(position){
    var y=position.coords.latitude,
        x=position.coords.longitude;
    pos=[y,x];
    var gl_text = "緯度：" + y + "<br>";
      gl_text += "経度：" + x + "<br>";
      gl_text += "高度：" + position.coords.altitude + "<br>";
      gl_text += "緯度・経度の誤差：" + position.coords.accuracy + "<br>";
      gl_text += "高度の誤差：" + position.coords.altitudeAccuracy + "<br>";
      gl_text += "方角：" + position.coords.heading + "<br>";
      gl_text += "速度：" + position.coords.speed + "<br>";
    $("#disp").html(gl_text);
    map.setCenter(new google.maps.LatLng(y, x));
    circle.setCenter(new google.maps.LatLng(y, x));
    setTimeout(call, 1000);
  };
  var error=function(){
    $("#error").html('GPS Error');
  };
  var call=function(){
    navigator.geolocation.getCurrentPosition(cb, error);
  };


  // create path sector
  var path, d=0.005, streetError=function(){
    $("#error").html('StreetMapAPI Error');
  }, getLine=function(){
    if(Math.pow(getpos[0]-pos[0],2)+
       Math.pow(getpos[1]-pos[1],2)>=d*d/4){
      $.ajax({
        url:"http://api.openstreetmap.org/api/"+
        "0.6/map?bbox="+
        [pos[1]-d,pos[0]-d,pos[1]+d,pos[0]+d].join()
        ,type:"GET",
        success:setLine
        ,error:streetError
      });
      getpos = pos.concat();
    }
    setTimeout(getLine, 10000);
  }, setLine=function(res){
    $("#xml").text(res);
    if(path)for(var i=0;i<path.length;++i){
      path[i].setMap(null);
    }
    path=[];
    $(res).find("way").filter(function(){
      return $(this)
         .find("tag[k=railway][v=rail]"
         /* +",tag[k=highway]" */ ).length;
    }).each(function(){
      var nd=[];
      var color=$(this).find("tag[k=railway]")
        .length?"#000":"#666";
      $(this).find("nd").each(function(){
        var ndd=$(res).find("node[id="+
          $(this).attr("ref")+
          "]")
        nd.push(new google.maps.LatLng(
          ndd.attr("lat"),
          ndd.attr("lon")
          ));
      });
      var p=new google.maps.Polyline({
        path:nd,strokeColor:color
      });
      path.push(p);
      p.setMap(map);
    });
  };

  // set google map
  var mapOptions = {
    center: defPos,
    zoom: 18,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  };
  map = new google.maps.Map($("#map_canvas")[0], mapOptions);

  var circleOptions = {
      strokeColor: "#555599",
      strokeOpacity: 0.8,
      strokeWeight: 1,
      fillColor: "#9999FF",
      fillOpacity: 0.35,
      map: map,
      center: defPos,
      radius: 5
  };
  circle = new google.maps.Circle(circleOptions);

  // call main thread
  if (navigator.geolocation) {
    call();
    setTimeout(getLine,500);
  } else {
    error();
  }

}
</script>
</head>
<body onload="initialize()" style="margin:0px;">
<div id="disp"></div>
<b id="error"></b>
<div id="map_canvas" style="width:100%;max-width:400px;height:400px;margin:0px;"></div>
<div id="xml"></div>
</body>
</html>